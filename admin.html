<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ziele-Admin – Mäusegruppe</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --txt:#1c1c1e; --muted:#6b7280;
    --pri:#007aff; --pri2:#005bb5; --ok:#16a34a; --warn:#f59e0b;
    --border:#e5e7eb; --radius:14px; --shadow:0 6px 20px rgba(0,0,0,.06);
  }
  body{font-family:'SF Pro Display',sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:16px}
  h1{font-size:22px;margin:0 0 16px;text-align:center;color:var(--pri)}
  .layout{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .search{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
  .kid{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer}
  .kid:hover{background:#f8fafc}
  .tag{font-size:12px;color:#fff;background:var(--pri);padding:2px 8px;border-radius:999px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:14px}
  select, input[type="number"], input[type="text"]{padding:10px;border:1px solid var(--border);border-radius:10px;min-width:120px}
  button{padding:10px 14px;border:none;border-radius:10px;background:var(--pri);color:#fff;cursor:pointer;font-weight:600}
  button:hover{background:var(--pri2)}
  button.ghost{background:#fff;color:var(--txt);border:1px solid var(--border)}
  .progress-wrap{width:100%;background:#eef2ff;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
  .progress{height:12px;background:linear-gradient(90deg,#22c55e,#60a5fa)}
  .list{display:grid;grid-template-columns:1fr;gap:8px}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fafafa}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .small{font-size:12px}
  .goal-row{display:grid;grid-template-columns:40px 1fr 140px 120px;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px}
  .goal-actions{display:flex;gap:6px;justify-content:flex-end}
  .danger{background:#ef4444}
  .danger:hover{background:#dc2626}
  .ok{background:#16a34a}
  .ok:hover{background:#15803d}
</style>
</head>
<body>
<h1>Ziele-Admin</h1>
<div class="layout">
  <!-- Kinderliste -->
  <div class="card">
    <input id="search" class="search" placeholder="Kind suchen…" />
    <div id="kidList" class="list" style="margin-top:12px"></div>
  </div>

  <!-- Detail & Zielverwaltung Tabs -->
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="row">
        <button id="tabKid" class="ghost">Kind bearbeiten</button>
        <button id="tabGoals" class="ghost">Ziele verwalten</button>
      </div>
      <div class="small muted" id="tabHint"></div>
    </div>
    <div id="detail"></div>
    <div id="goalsPanel" style="display:none"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, onValue, get, set, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

/* Firebase config: punkte-45c20 */
const app = initializeApp({
  apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
  authDomain: "punkte-45c20.firebaseapp.com",
  databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "punkte-45c20",
  storageBucket: "punkte-45c20.appspot.com",
  messagingSenderId: "931713539549",
  appId: "1:931713539549:web:e348bf38369639f1906a34"
});
const db = getDatabase(app);

/* Default-Ziele */
const DEFAULT_GOALS = [
  "Ich bin freundlich zu anderen.",
  "Ich rede in angemessener Lautstärke.",
  "Ich höre anderen zu und lasse sie ausreden.",
  "Ich respektiere die Grenzen anderer Kinder.",
  "Ich streite ohne Schubsen, Schlagen oder Beleidigen.",
  "Ich teile Dinge (Materialien, Essen).",
  "Ich helfe anderen, wenn sie Unterstützung brauchen.",
  "Ich erinnere andere freundlich an Regeln.",
  "Ich bleibe an meinem Platz sitzen.",
  "Ich spiele nicht mit dem Essen.",
  "Ich räume meine Sachen weg.",
  "Ich gehe langsam durch den Flur, ohne zu drängeln.",
  "Ich hole mir Hilfe, wenn ich alleine nicht weiterkomme.",
  "Ich plane meine Zeit eigenständig (Hausaufgaben, Spielen, Essen).",
  "Ich halte Regeln auch ohne Erinnerung ein.",
  "Ich bin ein Vorbild für andere Kinder."
];

let GOALS = [];
let allKids = [];
let currentKid = null;

const goalsRef = ref(db, "ziele/meta");

async function ensureGoals(){
  const s = await get(goalsRef);
  if (!s.exists() || !Array.isArray(s.val()) || s.val().length===0){
    await set(goalsRef, DEFAULT_GOALS);
    GOALS = [...DEFAULT_GOALS];
  } else {
    GOALS = s.val();
  }
}

/* Nur Kinder mit Farbe laden */
onValue(ref(db, "kinder"), async (snap)=>{
  await ensureGoals();
  const arr = [];
  snap.forEach(ch=>{
    const v = ch.val() || {};
    if (v.farbe === undefined) return; // Filter
    arr.push({
      name: ch.key,
      punkte: v.punkte||0,
      farbe: v.farbe,
      activeGoalIndex: clampIndex(v.activeGoalIndex ?? 0),
      progress: v.progress ?? 0,
      lastRewardedMilestone: v.lastRewardedMilestone ?? 0
    });
  });
  allKids = arr.sort((a,b)=>a.name.localeCompare(b.name,'de'));
  renderKidList();
  if (currentKid) openDetail(currentKid);
});

/* Tabs + Suche etc. – (Rest wie vorher, nicht gekürzt) ... */

/* Hilfsfunktionen */
function clamp01(x){ return Math.max(0, Math.min(100, x|0)); }
function clampIndex(i){ return Math.max(0, Math.min((GOALS.length?GOALS.length:1)-1, i|0)); }
function escapeHTML(s){ return (s??"").toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
function escapeAttr(s){ return escapeHTML(s).replace(/"/g,'&quot;'); }
</script>
</body>
</html>
