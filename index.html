<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√§usegruppe Ziele</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f9f9fb; --card:#ffffff; --txt:#1c1c1e; --muted:#6b7280;
    --border:#e5e5ea; --radius:12px; --shadow:0 2px 5px rgba(0,0,0,0.05);
    --accent:#007aff;
  }
  body{font-family:'SF Pro Display',sans-serif;background:var(--bg);color:var(--txt);margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px}
  h1{margin:0 0 20px;font-size:26px;font-weight:600;text-align:center}
  .card{background:var(--card);border:1px solid #ccc;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;width:95%;max-width:700px}
  .search{width:100%;max-width:340px;font-size:16px;padding:12px;margin:0 auto 12px;border:1px solid #ccc;border-radius:10px;display:block}
  .grid{display:flex;flex-direction:column;align-items:center;gap:12px}
  .kidBtn, .btn{background:#fff;border:1px solid #ccc;border-radius:12px;padding:18px 24px;font-size:20px;font-weight:600;color:#000;box-shadow:var(--shadow);cursor:pointer;width:95%;max-width:340px;text-align:center;transition:all .2s ease, transform .1s ease}
  .kidBtn:hover,.btn:hover{background:#f0f0f5}
  .kidBtn:active,.btn:active{background:#e0e0e5;transform:scale(0.97)}
  .toolbar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  .back{background:#ffffff;border:1px solid #ccc;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .title{font-size:20px;font-weight:600;margin-left:8px}
  .goalTag{font-size:12px;color:#007aff;background:#eef5ff;border:1px solid #d8e6ff;padding:3px 8px;border-radius:999px}
  .muted{color:var(--muted);font-size:12px}
  .progressWrap{width:100%;height:16px;background:#eef2ff;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:8px}
  .progressBar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#60a5fa);transition:width .6s ease}
  .toggles{display:flex;gap:6px;justify-content:flex-start;margin-top:12px}
  .mini{padding:6px 8px;font-size:12px;border-radius:10px;width:auto;max-width:none}
  .pillList{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fafafa;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
  <h1 id="title">M√§usegruppe Ziele</h1>

  <!-- LISTE -->
  <div id="listView" class="card">
    <input id="search" class="search" placeholder="Suche nach Namen‚Ä¶" />
    <div id="kidList" class="grid"></div>
  </div>

  <!-- DETAIL -->
  <div id="detailView" class="card hidden">
    <div class="toolbar">
      <button id="backBtn" class="back">üè† Zur√ºck</button>
      <div class="title" id="kidName"></div>
      <div style="flex:1"></div>
      <span class="goalTag" id="goalIndexTag"></span>
    </div>

    <div class="muted">Aktuelles Ziel</div>
    <div id="goalTitle" style="font-size:18px;font-weight:600;margin-top:4px"></div>

    <div class="progressWrap"><div id="bar" class="progressBar"></div></div>
    <div id="percent" class="muted" style="margin-top:6px"></div>

    <div class="toggles">
      <button id="btnPrev" class="btn mini">Vorherige Ziele</button>
      <button id="btnNext" class="btn mini">Zuk√ºnftige Ziele</button>
    </div>

    <div id="prevWrap" class="hidden">
      <div class="muted" style="margin-top:10px">Vorherige Ziele</div>
      <div id="prevGoals" class="pillList"></div>
    </div>

    <div id="nextWrap" class="hidden">
      <div class="muted" style="margin-top:10px">Zuk√ºnftige Ziele</div>
      <div id="nextGoals" class="pillList"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

/* Firebase: punkte-45c20 */
const app = initializeApp({
  apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
  authDomain: "punkte-45c20.firebaseapp.com",
  databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "punkte-45c20",
  storageBucket: "punkte-45c20.appspot.com",
  messagingSenderId: "931713539549",
  appId: "1:931713539549:web:e348bf38369639f1906a34"
});
const db = getDatabase(app);

/* DOM */
const listView = document.getElementById('listView');
const detailView = document.getElementById('detailView');
const kidList = document.getElementById('kidList');
const search = document.getElementById('search');
const backBtn = document.getElementById('backBtn');
const kidNameEl = document.getElementById('kidName');
const goalIndexTag = document.getElementById('goalIndexTag');
const goalTitle = document.getElementById('goalTitle');
const bar = document.getElementById('bar');
const percentEl = document.getElementById('percent');
const prevGoals = document.getElementById('prevGoals');
const nextGoals = document.getElementById('nextGoals');
const prevWrap = document.getElementById('prevWrap');
const nextWrap = document.getElementById('nextWrap');
const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');

/* State */
let GOALS = [];
let KIDS = []; // nur mit farbe

/* Ziele laden */
async function loadGoals(){
  const s = await get(ref(db,"ziele/meta"));
  if (s.exists() && Array.isArray(s.val())) GOALS = s.val();
  else {
    GOALS = [
      "Ich bin freundlich zu anderen.",
      "Ich rede in angemessener Lautst√§rke.",
      "Ich h√∂re anderen zu und lasse sie ausreden.",
      "Ich respektiere die Grenzen anderer Kinder.",
      "Ich streite ohne Schubsen, Schlagen oder Beleidigen.",
      "Ich teile Dinge (Materialien, Essen).",
      "Ich helfe anderen, wenn sie Unterst√ºtzung brauchen.",
      "Ich erinnere andere freundlich an Regeln.",
      "Ich bleibe an meinem Platz sitzen.",
      "Ich spiele nicht mit dem Essen.",
      "Ich r√§ume meine Sachen weg.",
      "Ich gehe langsam durch den Flur, ohne zu dr√§ngeln.",
      "Ich hole mir Hilfe, wenn ich alleine nicht weiterkomme.",
      "Ich plane meine Zeit eigenst√§ndig (Hausaufgaben, Spielen, Essen).",
      "Ich halte Regeln auch ohne Erinnerung ein.",
      "Ich bin ein Vorbild f√ºr andere Kinder."
    ];
  }
}

/* Kinder live laden (nur mit farbe) */
onValue(ref(db,"kinder"), async (snap)=>{
  await loadGoals();
  KIDS.length = 0;
  snap.forEach(ch=>{
    const v = ch.val()||{};
    if (v.farbe === undefined) return;
    KIDS.push({
      name: ch.key,
      activeGoalIndex: clampIndex(v.activeGoalIndex ?? 0),
      progress: clamp01(v.progress ?? 0)
    });
  });
  KIDS.sort((a,b)=>a.name.localeCompare(b.name,'de'));
  renderList();
});

/* Liste rendern */
function renderList(){
  const q = (search.value||"").toLowerCase();
  kidList.innerHTML = "";
  KIDS.filter(k=>k.name.toLowerCase().includes(q)).forEach(k=>{
    const btn = document.createElement('button');
    btn.className = 'kidBtn';
    btn.textContent = k.name;
    btn.onclick = ()=>openDetail(k.name);
    kidList.appendChild(btn);
  });
}
search.addEventListener('input', renderList);

/* Detail √∂ffnen */
async function openDetail(name){
  const s = await get(ref(db,`kinder/${name}`));
  if (!s.exists()) return;
  const v = s.val()||{};
  if (v.farbe === undefined) return;

  toggleViews(false);
  const idx = clampIndex(v.activeGoalIndex ?? 0);
  const prog = clamp01(v.progress ?? 0);

  kidNameEl.textContent = name;
  goalIndexTag.textContent = `Ziel ${idx+1}`;
  goalTitle.textContent = GOALS[idx] || "‚Äî";

  bar.style.width = "0%";
  requestAnimationFrame(()=>{ bar.style.width = prog + "%"; });
  percentEl.textContent = `Fortschritt: ${prog}%`;

  // Inhalte vorbereiten
  prevGoals.innerHTML = "";
  nextGoals.innerHTML = "";
  GOALS.slice(0, idx).forEach((t,i)=>{
    const span = document.createElement('span'); span.className="pill"; span.textContent = `#${i+1} ${t}`; prevGoals.appendChild(span);
  });
  GOALS.slice(idx+1).forEach((t,i)=>{
    const span = document.createElement('span'); span.className="pill"; span.textContent = `#${idx+2+i} ${t}`; nextGoals.appendChild(span);
  });
  // Standard: beide zu
  prevWrap.classList.add('hidden');
  nextWrap.classList.add('hidden');
}

/* Exklusive Toggles */
btnPrev.onclick = ()=>{
  const willShow = prevWrap.classList.contains('hidden');
  // exklusiv
  nextWrap.classList.add('hidden');
  prevWrap.classList.toggle('hidden', !willShow? true : false);
  if (willShow) prevWrap.classList.remove('hidden');
};
btnNext.onclick = ()=>{
  const willShow = nextWrap.classList.contains('hidden');
  // exklusiv
  prevWrap.classList.add('hidden');
  nextWrap.classList.toggle('hidden', !willShow? true : false);
  if (willShow) nextWrap.classList.remove('hidden');
};

/* Navigation */
backBtn.onclick = ()=>toggleViews(true);
function toggleViews(showList){
  listView.classList.toggle('hidden', !showList);
  detailView.classList.toggle('hidden', showList);
}

/* Utils */
function clamp01(x){ return Math.max(0, Math.min(100, x|0)); }
function clampIndex(i){ return Math.max(0, Math.min((GOALS.length?GOALS.length:1)-1, i|0)); }
</script>
</body>
</html>